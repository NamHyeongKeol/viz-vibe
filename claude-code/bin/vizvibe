#!/bin/bash

# Viz Vibe CLI
# Visual Context Map for AI Coding

VIZVIBE_HOME="${VIZVIBE_HOME:-$HOME/.vizvibe}"
TEMPLATE_PATH="$VIZVIBE_HOME/templates/vizvibe.mmd"
SERVER_SCRIPT="$VIZVIBE_HOME/bin/vizvibe-server.js"

print_help() {
    echo "Viz Vibe - Visual Context Map for AI Coding"
    echo ""
    echo "Usage: vizvibe <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init              Create vizvibe.mmd in current directory"
    echo "  view [file]       Open vizvibe.mmd in browser (live reload)"
    echo "  help              Show this help message"
    echo "  version           Show version information"
    echo ""
    echo "Examples:"
    echo "  vizvibe init              # Initialize vizvibe.mmd"
    echo "  vizvibe view              # View ./vizvibe.mmd in browser"
    echo "  vizvibe view path/to.mmd  # View specific file"
    echo ""
    echo "For more information, visit: https://github.com/NamHyeongKeol/viz-vibe"
}

print_version() {
    echo "Viz Vibe CLI v1.1.0"
}

do_init() {
    if [ -f "vizvibe.mmd" ]; then
        echo "‚ùå vizvibe.mmd already exists in this directory!"
        echo ""
        echo "If you want to reinitialize, delete or rename the existing file first."
        exit 1
    fi

    if [ ! -f "$TEMPLATE_PATH" ]; then
        echo "‚ùå Template not found at: $TEMPLATE_PATH"
        echo ""
        echo "Please reinstall Viz Vibe:"
        echo "  curl -fsSL https://raw.githubusercontent.com/NamHyeongKeol/viz-vibe/main/claude-code/install.sh | bash"
        exit 1
    fi

    cp "$TEMPLATE_PATH" ./vizvibe.mmd
    echo "‚úÖ Created vizvibe.mmd"
    
    # Add .vizvibe-state.json to .gitignore if not already present
    if [ -f ".gitignore" ]; then
        if ! grep -q "\.vizvibe-state\.json" .gitignore 2>/dev/null; then
            echo "" >> .gitignore
            echo "# Viz Vibe runtime state (Claude Code hooks)" >> .gitignore
            echo ".vizvibe-state.json" >> .gitignore
            echo "‚úÖ Added .vizvibe-state.json to .gitignore"
        fi
    else
        echo "# Viz Vibe runtime state (Claude Code hooks)" > .gitignore
        echo ".vizvibe-state.json" >> .gitignore
        echo "‚úÖ Created .gitignore with .vizvibe-state.json"
    fi
    
    echo ""
    echo "üí° Next steps:"
    echo "   1. View the graph: vizvibe view"
    echo "   2. Copy the setup prompt from the browser overlay"
    echo "   3. Start Claude Code: claude"
    echo "   4. Paste the prompt: \"Please setup vizvibe for this project. Write the trajectory in my language.\""
    echo ""
    echo "üìä Browser viewer runs at http://localhost:5125 with live reload"
}

do_view() {
    local target_file="${1:-vizvibe.mmd}"
    
    # If relative path, make it absolute
    if [[ ! "$target_file" = /* ]]; then
        target_file="$(pwd)/$target_file"
    fi
    
    if [ ! -f "$target_file" ]; then
        echo "‚ùå File not found: $target_file"
        echo ""
        echo "Run 'vizvibe init' to create vizvibe.mmd first."
        exit 1
    fi
    
    if [ ! -f "$SERVER_SCRIPT" ]; then
        echo "‚ùå Browser viewer not installed."
        echo ""
        echo "Please reinstall Viz Vibe:"
        echo "  curl -fsSL https://raw.githubusercontent.com/NamHyeongKeol/viz-vibe/main/claude-code/install.sh | bash"
        exit 1
    fi
    
    # Check if Node.js is available
    if ! command -v node &> /dev/null; then
        echo "‚ùå Node.js is required but not installed."
        echo ""
        echo "Install Node.js: https://nodejs.org/"
        exit 1
    fi
    
    # Run the server
    node "$SERVER_SCRIPT" "$target_file"
}

# Main command handler
case "${1:-help}" in
    init)
        do_init
        ;;
    view)
        do_view "$2"
        ;;
    help|--help|-h)
        print_help
        ;;
    version|--version|-v)
        print_version
        ;;
    *)
        echo "Unknown command: $1"
        echo ""
        print_help
        exit 1
        ;;
esac
