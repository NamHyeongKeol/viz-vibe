#!/bin/bash

# Viz Vibe CLI
# Visual Context Map for AI Coding

VIZVIBE_HOME="${VIZVIBE_HOME:-$HOME/.vizvibe}"
TEMPLATE_PATH="$VIZVIBE_HOME/templates/vizvibe.mmd"
SERVER_SCRIPT="$VIZVIBE_HOME/bin/vizvibe-server.js"

print_help() {
    echo "Viz Vibe - Visual Context Map for AI Coding"
    echo ""
    echo "Usage: vizvibe <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init              Create vizvibe.mmd in current directory"
    echo "  view [file]       Open vizvibe.mmd in browser (live reload)"
    echo "  uninstall         Remove Viz Vibe globally and clean configurations"
    echo "  help              Show this help message"
    echo "  version           Show version information"
    echo ""
    echo "Examples:"
    echo "  vizvibe init              # Initialize vizvibe.mmd"
    echo "  vizvibe view              # View ./vizvibe.mmd in browser"
    echo "  vizvibe view path/to.mmd  # View specific file"
    echo ""
    echo "For more information, visit: https://github.com/NamHyeongKeol/viz-vibe"
}

print_version() {
    echo "Viz Vibe CLI v1.3.0"
}

# Setup vizvibe hooks in local .claude folder
# Always creates local hooks to prevent conflicts when Claude Code creates .claude/ later
setup_local_claude_hooks() {
    local LOCAL_CLAUDE="./.claude"
    local LOCAL_HOOKS="$LOCAL_CLAUDE/hooks"
    local LOCAL_SETTINGS="$LOCAL_CLAUDE/settings.local.json"

    echo ""
    echo "üîß Setting up local Claude Code hooks..."

    # Create .claude directory if it doesn't exist
    mkdir -p "$LOCAL_CLAUDE"

    # Create hooks directory if needed
    mkdir -p "$LOCAL_HOOKS"

    # Copy hook scripts from global installation
    if [ -f "$VIZVIBE_HOME/scripts/read-vizvibe.js" ]; then
        cp "$VIZVIBE_HOME/scripts/read-vizvibe.js" "$LOCAL_HOOKS/"
        cp "$VIZVIBE_HOME/scripts/update-vizvibe.js" "$LOCAL_HOOKS/"
        echo "   ‚úÖ Copied hook scripts to $LOCAL_HOOKS/"
    else
        echo "   ‚ö†Ô∏è  Global hook scripts not found. Skipping local hook setup."
        return 0
    fi

    # Merge vizvibe hooks into local settings.local.json
    if [ -f "$LOCAL_SETTINGS" ]; then
        # Parse and merge using Node.js
        MERGED_SETTINGS=$(node -e "
const fs = require('fs');
const settingsPath = '$LOCAL_SETTINGS';

try {
    // Vizvibe hooks with local paths
    const vizvibeHooksToAdd = {
        SessionStart: {
            startup: { type: 'command', command: 'node \"\$CLAUDE_PROJECT_DIR/.claude/hooks/read-vizvibe.js\"' },
            resume: { type: 'command', command: 'node \"\$CLAUDE_PROJECT_DIR/.claude/hooks/read-vizvibe.js\"' }
        },
        Stop: {
            _default: { type: 'command', command: 'node \"\$CLAUDE_PROJECT_DIR/.claude/hooks/update-vizvibe.js\"' }
        }
    };

    let settings = {};
    if (fs.existsSync(settingsPath)) {
        settings = JSON.parse(fs.readFileSync(settingsPath, 'utf-8'));
    }

    // Merge hooks
    if (!settings.hooks) {
        settings.hooks = {};
    }

    // Check if already installed
    const existingStr = JSON.stringify(settings.hooks);
    if (existingStr.includes('vizvibe') || existingStr.includes('read-vizvibe')) {
        console.log('ALREADY_INSTALLED');
        process.exit(0);
    }

    // SessionStart hooks - merge by matcher
    if (!settings.hooks.SessionStart) {
        settings.hooks.SessionStart = [];
    }

    for (const [matcher, hookToAdd] of Object.entries(vizvibeHooksToAdd.SessionStart)) {
        let existingEntry = settings.hooks.SessionStart.find(e => e.matcher === matcher);
        if (existingEntry) {
            if (!existingEntry.hooks) existingEntry.hooks = [];
            existingEntry.hooks.push(hookToAdd);
        } else {
            settings.hooks.SessionStart.push({ matcher, hooks: [hookToAdd] });
        }
    }

    // Stop hooks - merge into hooks array
    if (!settings.hooks.Stop) {
        settings.hooks.Stop = [];
    }

    let existingStopEntry = settings.hooks.Stop.find(e => !e.matcher) || settings.hooks.Stop[0];
    if (existingStopEntry) {
        if (!existingStopEntry.hooks) existingStopEntry.hooks = [];
        existingStopEntry.hooks.push(vizvibeHooksToAdd.Stop._default);
    } else {
        settings.hooks.Stop.push({ hooks: [vizvibeHooksToAdd.Stop._default] });
    }

    console.log(JSON.stringify(settings, null, 2));

} catch (e) {
    console.log('ERROR_PARSE:' + e.message);
}
" 2>/dev/null)

        if [[ "$MERGED_SETTINGS" == ERROR_PARSE:* ]]; then
            echo "   ‚ö†Ô∏è  Could not parse local settings.local.json: ${MERGED_SETTINGS#ERROR_PARSE:}"
            echo "   Please manually add vizvibe hooks to $LOCAL_SETTINGS"
        elif [ "$MERGED_SETTINGS" = "ALREADY_INSTALLED" ]; then
            echo "   ‚úÖ Vizvibe hooks already configured in local settings.local.json"
        else
            # Backup and update
            cp "$LOCAL_SETTINGS" "$LOCAL_SETTINGS.backup"
            echo "$MERGED_SETTINGS" > "$LOCAL_SETTINGS"
            echo "   ‚úÖ Merged vizvibe hooks into $LOCAL_SETTINGS"
            echo "   üì¶ Backup saved to $LOCAL_SETTINGS.backup"
        fi
    else
        # Create new settings.json with vizvibe hooks
        cat > "$LOCAL_SETTINGS" << 'SETTINGS_EOF'
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "startup",
        "hooks": [{ "type": "command", "command": "node \"$CLAUDE_PROJECT_DIR/.claude/hooks/read-vizvibe.js\"" }]
      },
      {
        "matcher": "resume",
        "hooks": [{ "type": "command", "command": "node \"$CLAUDE_PROJECT_DIR/.claude/hooks/read-vizvibe.js\"" }]
      }
    ],
    "Stop": [
      {
        "hooks": [{ "type": "command", "command": "node \"$CLAUDE_PROJECT_DIR/.claude/hooks/update-vizvibe.js\"" }]
      }
    ]
  }
}
SETTINGS_EOF
        echo "   ‚úÖ Created $LOCAL_SETTINGS with vizvibe hooks"
    fi
}

do_init() {
    if [ -f "vizvibe.mmd" ]; then
        echo "‚ùå vizvibe.mmd already exists in this directory!"
        echo ""
        echo "If you want to reinitialize, delete or rename the existing file first."
        exit 1
    fi

    if [ ! -f "$TEMPLATE_PATH" ]; then
        echo "‚ùå Template not found at: $TEMPLATE_PATH"
        echo ""
        echo "Please reinstall Viz Vibe:"
        echo "  curl -fsSL https://raw.githubusercontent.com/NamHyeongKeol/viz-vibe/main/claude-code/install.sh | bash"
        exit 1
    fi

    cp "$TEMPLATE_PATH" ./vizvibe.mmd
    echo "‚úÖ Created vizvibe.mmd"

    # Add vizvibe files to .gitignore if not already present
    if [ -f ".gitignore" ]; then
        if ! grep -q "\.vizvibe-state\.json" .gitignore 2>/dev/null; then
            echo "" >> .gitignore
            echo "# Viz Vibe runtime state and backups" >> .gitignore
            echo ".vizvibe-state.json" >> .gitignore
            echo ".claude/settings.local.json" >> .gitignore
            echo ".claude/settings.local.json.backup" >> .gitignore
            echo "‚úÖ Added vizvibe files to .gitignore"
        fi
    else
        echo "# Viz Vibe runtime state and backups" > .gitignore
        echo ".vizvibe-state.json" >> .gitignore
        echo ".claude/settings.local.json" >> .gitignore
        echo ".claude/settings.local.json.backup" >> .gitignore
        echo "‚úÖ Created .gitignore with vizvibe files"
    fi

    # Always set up local .claude hooks (prevents conflicts when Claude Code creates .claude/ later)
    setup_local_claude_hooks

    echo ""
    echo "üí° Next steps:"
    echo "   1. View the graph: vizvibe view"
    echo "   2. Copy the setup prompt from the browser overlay"
    echo "   3. Start Claude Code: claude"
    echo "   4. Paste the prompt: \"Please setup vizvibe for this project. Write the trajectory in my language.\""
    echo ""
    echo "üìä Browser viewer runs at http://localhost:5125 with live reload"
}

do_view() {
    local target_file="${1:-vizvibe.mmd}"
    
    # If relative path, make it absolute
    if [[ ! "$target_file" = /* ]]; then
        target_file="$(pwd)/$target_file"
    fi
    
    if [ ! -f "$target_file" ]; then
        echo "‚ùå File not found: $target_file"
        echo ""
        echo "Run 'vizvibe init' to create vizvibe.mmd first."
        exit 1
    fi
    
    if [ ! -f "$SERVER_SCRIPT" ]; then
        echo "‚ùå Browser viewer not installed."
        echo ""
        echo "Please reinstall Viz Vibe:"
        echo "  curl -fsSL https://raw.githubusercontent.com/NamHyeongKeol/viz-vibe/main/claude-code/install.sh | bash"
        exit 1
    fi
    
    # Check if Node.js is available
    if ! command -v node &> /dev/null; then
        echo "‚ùå Node.js is required but not installed."
        echo ""
        echo "Install Node.js: https://nodejs.org/"
        exit 1
    fi
    
    # Run the server
    node "$SERVER_SCRIPT" "$target_file"
}

do_uninstall() {
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë          Viz Vibe - Global Uninstallation                  ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "‚ö†Ô∏è  This will uninstall Viz Vibe globally and remove all configurations."
    read -p "Are you sure? (y/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi

    echo "üóëÔ∏è  Removing Claude Code hooks and settings..."
    
    # Use Node.js to cleanly remove vizvibe hooks from settings.json
    CLAUDE_SETTINGS_PATH="$HOME/.claude/settings.json"
    if [ -f "$CLAUDE_SETTINGS_PATH" ]; then
        CLEANED_SETTINGS=$(node -e "
        const fs = require('fs');
        const settingsPath = '$CLAUDE_SETTINGS_PATH';
        try {
            if (!fs.existsSync(settingsPath)) process.exit(0);
            let settings = JSON.parse(fs.readFileSync(settingsPath, 'utf-8'));
            if (!settings.hooks) { console.log(JSON.stringify(settings, null, 2)); process.exit(0); }

            const cleanHooks = (hookList) => {
                if (!hookList) return hookList;
                return hookList.map(entry => {
                    if (entry.hooks) {
                        entry.hooks = entry.hooks.filter(h => 
                            !(h.command && h.command.includes('vizvibe')) && 
                            !(h.command && h.command.includes('read-vizvibe.js')) &&
                            !(h.command && h.command.includes('update-vizvibe.js'))
                        );
                    }
                    return entry;
                }).filter(entry => entry.hooks && entry.hooks.length > 0);
            };

            if (settings.hooks.SessionStart) settings.hooks.SessionStart = cleanHooks(settings.hooks.SessionStart);
            if (settings.hooks.Stop) settings.hooks.Stop = cleanHooks(settings.hooks.Stop);
            
            console.log(JSON.stringify(settings, null, 2));
        } catch (e) {
            console.error('ERROR_PARSE:' + e.message);
            process.exit(1);
        }
        " 2>/dev/null)
        
        if [ $? -eq 0 ] && [ -n "$CLEANED_SETTINGS" ]; then
            echo "$CLEANED_SETTINGS" > "$CLAUDE_SETTINGS_PATH"
            echo "   ‚úÖ Cleaned $CLAUDE_SETTINGS_PATH"
        else
            echo "   ‚ö†Ô∏è  Could not clean settings.json automatically. Please check manually."
        fi
    fi

    # Remove files
    rm -f "$HOME/.claude/hooks/read-vizvibe.js" "$HOME/.claude/hooks/update-vizvibe.js" "$HOME/.claude/hooks/VIZVIBE.md"
    rm -rf "$HOME/.claude/skills/vizvibe"
    echo "   ‚úÖ Removed Claude hooks and skills"

    # Clean up shell rc
    echo "üóëÔ∏è  Cleaning up shell configuration..."
    for rc_file in "$HOME/.zshrc" "$HOME/.bashrc" "$HOME/.profile"; do
        if [ -f "$rc_file" ]; then
            if grep -q "VIZVIBE_HOME" "$rc_file" 2>/dev/null; then
                # Create temp file without vizvibe lines
                sed -i.bak '/VIZVIBE_HOME/d' "$rc_file"
                sed -i.bak '/# Viz Vibe/d' "$rc_file"
                rm -f "${rc_file}.bak"
                echo "   Cleaned $rc_file"
            fi
        fi
    done

    # Remove VIZVIBE_HOME last
    if [ -d "$VIZVIBE_HOME" ]; then
        echo "üóëÔ∏è  Removing $VIZVIBE_HOME..."
        rm -rf "$VIZVIBE_HOME"
    fi

    echo ""
    echo "‚úÖ Viz Vibe has been uninstalled."
    echo "   Note: vizvibe.mmd files in your projects were not deleted."
    echo ""
}

# Main command handler
case "${1:-help}" in
    init)
        do_init
        ;;
    view)
        do_view "$2"
        ;;
    uninstall)
        do_uninstall
        ;;
    help|--help|-h)
        print_help
        ;;
    version|--version|-v)
        print_version
        ;;
    *)
        echo "Unknown command: $1"
        echo ""
        print_help
        exit 1
        ;;
esac
