#!/bin/bash

# Viz Vibe CLI
# Visual Context Map for AI Coding

VIZVIBE_HOME="${VIZVIBE_HOME:-$HOME/.vizvibe}"
TEMPLATE_PATH="$VIZVIBE_HOME/templates/vizvibe.mmd"
SERVER_SCRIPT="$VIZVIBE_HOME/bin/vizvibe-server.js"

print_help() {
    echo "Viz Vibe - Visual Context Map for AI Coding"
    echo ""
    echo "Usage: vizvibe <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init              Initialize .vizvibe/ folder structure (v2.0)"
    echo "  view [file]       Open trajectory in browser (live reload)"
    echo "  migrate           Migrate legacy vizvibe.mmd to .vizvibe/ folder"
    echo "  uninstall         Remove Viz Vibe globally and clean configurations"
    echo "  help              Show this help message"
    echo "  version           Show version information"
    echo ""
    echo "Examples:"
    echo "  vizvibe init              # Create .vizvibe/ folder structure"
    echo "  vizvibe view              # View trajectory in browser"
    echo "  vizvibe migrate           # Migrate legacy vizvibe.mmd to .vizvibe/"
    echo ""
    echo "For more information, visit: https://github.com/NamHyeongKeol/viz-vibe"
}

print_version() {
    echo "Viz Vibe CLI v2.0.0"
}

do_init() {
    # Check if already initialized (v2.0 or legacy)
    if [ -d ".vizvibe" ] && [ -f ".vizvibe/trajectory.mmd" ]; then
        echo "‚ùå .vizvibe/ folder already exists in this directory!"
        echo ""
        echo "If you want to reinitialize, delete .vizvibe/ folder first."
        exit 1
    fi
    
    if [ -f "vizvibe.mmd" ]; then
        echo "‚ùå Legacy vizvibe.mmd exists in this directory!"
        echo ""
        echo "Run 'vizvibe migrate' to upgrade to v2.0 folder structure."
        exit 1
    fi

    # Create v2.0 folder structure
    mkdir -p .vizvibe/nodes
    echo "‚úÖ Created .vizvibe/ folder structure"

    # Create trajectory.mmd
    cat > .vizvibe/trajectory.mmd << 'EOF'
flowchart TD
    %% === PROJECT GOALS ===
    %% Ultimate Goal: [Describe your project's ultimate goal]
    %% Current Goal: [Describe your current focus]
    %% @lastActive: project_start

    %% @project_start [start, closed]
    project_start("Project Start<br/><sub>Viz Vibe initialized<br/>Ready to track trajectory</sub>")

    %% @ultimate_goal [end, opened]
    ultimate_goal("Ultimate Goal<br/><sub>Your project's final<br/>objective goes here</sub>")

    project_start -.-> ultimate_goal

    subgraph recent [RECENT]
        project_start
    end

    %% === STYLES ===
    style project_start fill:#1a1a2e,stroke:#6b7280,color:#9ca3af,stroke-width:1px
    style ultimate_goal fill:#1a1a2e,stroke:#6b7280,color:#9ca3af,stroke-width:1px
    style recent fill:transparent,stroke:#c084fc,color:#c084fc,stroke-width:2px,stroke-dasharray:5 5
EOF
    echo "‚úÖ Created .vizvibe/trajectory.mmd"

    # Create state.json
    cat > .vizvibe/state.json << EOF
{
  "version": "2.0",
  "createdAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "lastActiveNode": "project_start"
}
EOF
    echo "‚úÖ Created .vizvibe/state.json"
    
    # Add .vizvibe/state.json to .gitignore
    if [ -f ".gitignore" ]; then
        if ! grep -q "\.vizvibe/state\.json" .gitignore 2>/dev/null; then
            echo "" >> .gitignore
            echo "# Viz Vibe runtime state" >> .gitignore
            echo ".vizvibe/state.json" >> .gitignore
            echo "‚úÖ Added .vizvibe/state.json to .gitignore"
        fi
    else
        echo "# Viz Vibe runtime state" > .gitignore
        echo ".vizvibe/state.json" >> .gitignore
        echo "‚úÖ Created .gitignore with .vizvibe/state.json"
    fi
    
    echo ""
    echo "üí° Next steps:"
    echo "   1. View the graph: vizvibe view"
    echo "   2. Start Claude Code: claude"
    echo "   3. AI will auto-detect and set up your trajectory"
    echo ""
    echo "üìä Browser viewer runs at http://localhost:5125 with live reload"
}

do_view() {
    local target_file="$1"
    
    # Auto-detect trajectory file if not specified
    if [ -z "$target_file" ]; then
        if [ -f ".vizvibe/trajectory.mmd" ]; then
            target_file=".vizvibe/trajectory.mmd"
        elif [ -f "vizvibe.mmd" ]; then
            target_file="vizvibe.mmd"
        else
            echo "‚ùå No trajectory file found."
            echo ""
            echo "Run 'vizvibe init' to create one."
            exit 1
        fi
    fi
    
    # If relative path, make it absolute
    if [[ ! "$target_file" = /* ]]; then
        target_file="$(pwd)/$target_file"
    fi
    
    if [ ! -f "$target_file" ]; then
        echo "‚ùå File not found: $target_file"
        exit 1
    fi
    
    if [ ! -f "$SERVER_SCRIPT" ]; then
        echo "‚ùå Browser viewer not installed."
        echo ""
        echo "Please reinstall Viz Vibe:"
        echo "  curl -fsSL https://raw.githubusercontent.com/NamHyeongKeol/viz-vibe/main/claude-code/install.sh | bash"
        exit 1
    fi
    
    # Check if Node.js is available
    if ! command -v node &> /dev/null; then
        echo "‚ùå Node.js is required but not installed."
        echo ""
        echo "Install Node.js: https://nodejs.org/"
        exit 1
    fi
    
    echo "üìä Opening $(basename "$target_file") in browser..."
    # Run the server
    node "$SERVER_SCRIPT" "$target_file"
}

do_migrate() {
    if [ ! -f "vizvibe.mmd" ]; then
        echo "‚ùå No vizvibe.mmd found to migrate."
        echo ""
        echo "Run 'vizvibe init' to create a new v2.0 structure."
        exit 1
    fi
    
    if [ -d ".vizvibe" ]; then
        echo "‚ùå .vizvibe/ folder already exists."
        echo ""
        echo "Migration aborted to prevent data loss."
        exit 1
    fi
    
    echo "üîÑ Migrating to v2.0 folder structure..."
    
    # Create folder structure
    mkdir -p .vizvibe/nodes
    
    # Move trajectory file
    mv vizvibe.mmd .vizvibe/trajectory.mmd
    echo "   ‚úÖ Moved vizvibe.mmd ‚Üí .vizvibe/trajectory.mmd"
    
    # Create state.json
    cat > .vizvibe/state.json << EOF
{
  "version": "2.0",
  "migratedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "migratedFrom": "1.x"
}
EOF
    echo "   ‚úÖ Created .vizvibe/state.json"
    
    # Update .gitignore
    if [ -f ".gitignore" ]; then
        # Remove old entry if exists
        if grep -q "\.vizvibe-state\.json" .gitignore 2>/dev/null; then
            sed -i.bak '/\.vizvibe-state\.json/d' .gitignore
            rm -f .gitignore.bak
        fi
        # Add new entry
        if ! grep -q "\.vizvibe/state\.json" .gitignore 2>/dev/null; then
            echo "" >> .gitignore
            echo "# Viz Vibe runtime state" >> .gitignore
            echo ".vizvibe/state.json" >> .gitignore
        fi
    fi
    
    # Clean up old state file if exists
    if [ -f ".vizvibe-state.json" ]; then
        rm -f .vizvibe-state.json
        echo "   ‚úÖ Removed legacy .vizvibe-state.json"
    fi
    
    echo ""
    echo "‚úÖ Migration complete!"
    echo ""
    echo "New structure:"
    echo "   .vizvibe/"
    echo "   ‚îú‚îÄ‚îÄ trajectory.mmd"
    echo "   ‚îú‚îÄ‚îÄ nodes/"
    echo "   ‚îî‚îÄ‚îÄ state.json"
}

do_uninstall() {
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë          Viz Vibe - Global Uninstallation                  ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "‚ö†Ô∏è  This will uninstall Viz Vibe globally and remove all configurations."
    read -p "Are you sure? (y/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi

    echo "üóëÔ∏è  Removing Claude Code hooks and settings..."
    
    # Use Node.js to cleanly remove vizvibe hooks from settings.json
    CLAUDE_SETTINGS_PATH="$HOME/.claude/settings.json"
    if [ -f "$CLAUDE_SETTINGS_PATH" ]; then
        CLEANED_SETTINGS=$(node -e "
        const fs = require('fs');
        const settingsPath = '$CLAUDE_SETTINGS_PATH';
        try {
            if (!fs.existsSync(settingsPath)) process.exit(0);
            let settings = JSON.parse(fs.readFileSync(settingsPath, 'utf-8'));
            if (!settings.hooks) { console.log(JSON.stringify(settings, null, 2)); process.exit(0); }

            const cleanHooks = (hookList) => {
                if (!hookList) return hookList;
                return hookList.map(entry => {
                    if (entry.hooks) {
                        entry.hooks = entry.hooks.filter(h => 
                            !(h.command && h.command.includes('vizvibe')) && 
                            !(h.command && h.command.includes('read-vizvibe.js')) &&
                            !(h.command && h.command.includes('update-vizvibe.js'))
                        );
                    }
                    return entry;
                }).filter(entry => entry.hooks && entry.hooks.length > 0);
            };

            if (settings.hooks.SessionStart) settings.hooks.SessionStart = cleanHooks(settings.hooks.SessionStart);
            if (settings.hooks.Stop) settings.hooks.Stop = cleanHooks(settings.hooks.Stop);
            
            console.log(JSON.stringify(settings, null, 2));
        } catch (e) {
            console.error('ERROR_PARSE:' + e.message);
            process.exit(1);
        }
        " 2>/dev/null)
        
        if [ $? -eq 0 ] && [ -n "$CLEANED_SETTINGS" ]; then
            echo "$CLEANED_SETTINGS" > "$CLAUDE_SETTINGS_PATH"
            echo "   ‚úÖ Cleaned $CLAUDE_SETTINGS_PATH"
        else
            echo "   ‚ö†Ô∏è  Could not clean settings.json automatically. Please check manually."
        fi
    fi

    # Remove files
    rm -f "$HOME/.claude/hooks/read-vizvibe.js" "$HOME/.claude/hooks/update-vizvibe.js" "$HOME/.claude/hooks/VIZVIBE.md"
    rm -rf "$HOME/.claude/skills/vizvibe"
    echo "   ‚úÖ Removed Claude hooks and skills"

    # Clean up shell rc
    echo "üóëÔ∏è  Cleaning up shell configuration..."
    for rc_file in "$HOME/.zshrc" "$HOME/.bashrc" "$HOME/.profile"; do
        if [ -f "$rc_file" ]; then
            if grep -q "VIZVIBE_HOME" "$rc_file" 2>/dev/null; then
                # Create temp file without vizvibe lines
                sed -i.bak '/VIZVIBE_HOME/d' "$rc_file"
                sed -i.bak '/# Viz Vibe/d' "$rc_file"
                rm -f "${rc_file}.bak"
                echo "   Cleaned $rc_file"
            fi
        fi
    done

    # Remove VIZVIBE_HOME last
    if [ -d "$VIZVIBE_HOME" ]; then
        echo "üóëÔ∏è  Removing $VIZVIBE_HOME..."
        rm -rf "$VIZVIBE_HOME"
    fi

    echo ""
    echo "‚úÖ Viz Vibe has been uninstalled."
    echo "   Note: vizvibe.mmd files in your projects were not deleted."
    echo ""
}

# Main command handler
case "${1:-help}" in
    init)
        do_init
        ;;
    view)
        do_view "$2"
        ;;
    migrate)
        do_migrate
        ;;
    uninstall)
        do_uninstall
        ;;
    help|--help|-h)
        print_help
        ;;
    version|--version|-v)
        print_version
        ;;
    *)
        echo "Unknown command: $1"
        echo ""
        print_help
        exit 1
        ;;
esac
